{# templates/seeStory.html.twig #}
{% include 'header.html.twig' with {'genres':genres, 'userPfp': userPfp} %}
{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('css/ComonStyles.css') }}">
    <link rel="stylesheet" href="{{ asset('css/Stories.css') }}">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap">
{% endblock %}
{% block body %}
<body>
    {% if story %}
        <div id='{{ story.storyID }}' class='container card'>
            {% set hasFaved = false %}
            {% for storyInArray in user.favStories %}
                {% if storyInArray.storyID == story.storyID %}
                    {% set hasFaved = true %}
                {% endif %}
            {% endfor %}
            <div class="container card-header">
                <div>
                    <h2 class="d-flex">
                        {% if hasFaved == true %}
                            <form action="{{ path('fav') }}" method="POST">
                                <input type="hidden" name="storyID" value="{{ story.storyID }}">
                                <input type="hidden" name="action" value="unfav">
                                <button type="submit" class="btn btn-primary favButton"><img class="logo" src="{{ asset('Images/heartfilled.png') }}" alt="heart" style="height: 1.8em; width: auto;"></button>
                            </form>
                        {% else %}
                            <form action="{{ path('fav') }}" method="POST">
                                <input type="hidden" name="storyID" value="{{ story.storyID }}">
                                <input type="hidden" name="action" value="fav">
                                <button type="submit" class="btn btn-primary favButton"><img class="logo" src="{{ asset('Images/heart.png') }}" alt="heart" style="height: 1.8em; width: auto;"></button>
                            </form>
                        {% endif %}
                        {{ story.storyTitle }} 
                    </h2>
                    <div class="by">
                        by 
                        {% if story.user.userId == 161 %}
                            DELETED
                        {% else %}
                            <a href="{{ path('otherProfile', {'id': story.user.userId})}}"> {{ story.user.username }}</a>
                        {% endif %}
                        {% if story.collabUsers|length > 0 %}
                            {% for collaborator in story.collabUsers %}
                                , <a href="{{ path('otherProfile', {'id': collaborator.userId}) }}"> {{ collaborator.username }}</a>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            
                <div class = "card-text">
                    <div>This story has 
                    {% if story.usersThatFaved.count == 1  %}
                        1 like
                    {% else %}
                        {{ story.usersThatFaved.count }} likes
                    {% endif %}
                    </div>
                    <div class='dateTime'> {{ story.datetime|date('d-M-Y H:i:s') }}</div>
                </div>
            </div>
            <p><pre class="card-body">{{ story.storyText|raw }}</pre></p>
        </div>
    
        <div class='container card'>
            <div class="card-title m-3">Comments</div> 
            <div id='commentForm' class="card-text m-3">
                <form action="{{ path('comment') }}" method='POST'>
                    <input name='storyId' value="{{ story.storyID }}" type='hidden'>
                    <input type="text" name='text' placeholder='Write a comment...'>
                    <button type='submit' class="btn btn-primary">Comment</button>
                </form>
            </div>
            {% if error is not null %}
                <div style="color: red">{{ error }}</div>
            {% endif %}
            {% if success is not null %}
                <div style="color: green">{{ success }}</div>
            {% endif %}
            <div id='comments'>
            {% if comments|length > 0 %}
                {% for comment in comments %}
                    <div class="comment card">
                        <div class="card-body d-flex">
                            {% if comment.user.imageBase64 is not null and comment.user.imageBase64 is defined %}
                                <img src="data:image/jpg;charset=utf8;base64,{{ comment.user.imageBase64}}" class="pfp">
                            {% else %}
                                <img src="{{ asset('Images/user.png') }}" class="pfp">
                            {% endif %}
                            <div class="commentInfo">
                                <h6><a href="{{ path('otherProfile', {'id': comment.user.userId })}}">{{ comment.user.username }}</a></h6>
                                <p class="text-muted small mb-0">commented on  {{ comment.datetime|date('d-M-Y H:i:s') }}</p>
                            </div>
                        </div>
                        <div class="m-3 pb-2"><pre>{{ comment.commentText }}</pre></div> 
                    </div>
                {% endfor %}    
            {% else %}
                This story doesn't have comments yet
            {% endif %}
            </div>
        </div>
    {% endif %}
</body>
{% endblock %}